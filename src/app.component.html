<!--
  Angular Applet
  This file was generated by AI Studio.
-->
@if (showIntro()) {
  <app-intro (enter)="enterApp()"></app-intro>
} @else {
  <!-- OVERLAYS: These components render on top of the main content -->
  @if (showAbout()) {
    <app-about (close)="closeAbout()"></app-about>
  }

  <!-- Battle History Panel -->
  @if (showHistory()) {
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] animate-fade-in-fast" (click)="toggleHistory()"></div>
    <aside class="fixed top-0 right-0 h-full w-full max-w-md bg-slate-100 dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 shadow-2xl z-[70] flex flex-col animate-slide-in-right">
      <header class="p-4 flex justify-between items-center border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
        <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">Battle History</h2>
        <button (click)="toggleHistory()" class="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors" aria-label="Close history">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </header>
      <main class="overflow-y-auto p-4 flex-grow">
        @if (battleHistory().length > 0) {
          <ul class="space-y-3">
            @for (entry of battleHistory(); track entry.id) {
              <li class="bg-white dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600/50 transition-shadow hover:shadow-md">
                <div class="flex justify-between items-center">
                  <div class="flex-1 min-w-0 pr-2">
                    <p class="font-semibold text-sm text-slate-800 dark:text-slate-200 truncate" [title]="entry.fighter1 + ' vs ' + entry.fighter2">{{ entry.fighter1 }} vs {{ entry.fighter2 }}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Winner: <span class="font-bold text-amber-600 dark:text-amber-400">{{ entry.winner }}</span></p>
                  </div>
                  <button (click)="rerunBattle(entry)" class="px-2.5 py-1.5 rounded-md text-xs font-semibold bg-indigo-500 text-white hover:bg-indigo-600 transition-colors shadow-sm flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201 2.366l-.31.31A1 1 0 0 1 4.39 12.7l1.13-3.216a1 1 0 0 1 1.414 1.414l-3.216 1.13a1 1 0 0 1-1.414-1.414l.31-.31a7.5 7.5 0 0 0 12.548-3.232 1 1 0 0 1 1.89.654ZM4.688 8.576a5.5 5.5 0 0 1 9.201-2.366l.31-.31a1 1 0 1 1 1.414 1.414l-1.13 3.216a1 1 0 0 1-1.414-1.414l3.216-1.13a1 1 0 0 1 1.414 1.414l-.31.31a7.5 7.5 0 0 0-12.548 3.232 1 1 0 0 1-1.89-.654Z" clip-rule="evenodd" />
                    </svg>
                    <span>Re-run</span>
                  </button>
                </div>
              </li>
            }
          </ul>
        } @else {
          <div class="h-full flex flex-col items-center justify-center text-center text-slate-500 dark:text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-3 text-slate-400 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="font-semibold">No Battles Yet</p>
            <p class="text-sm">Your battle history will appear here.</p>
          </div>
        }
      </main>
      @if (battleHistory().length > 0) {
        <footer class="p-4 border-t border-slate-200 dark:border-slate-700 flex-shrink-0">
          <button (click)="clearHistory()" class="w-full text-center px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/40 dark:text-red-300 dark:hover:bg-red-900/70 transition-colors">
            Clear History
          </button>
        </footer>
      }
    </aside>
  }

  <!-- Character Lore Loading State -->
  @if (isCharacterLoreLoading()) {
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center animate-fade-in-fast">
      <div class="flex flex-col items-center gap-4">
        <svg class="animate-spin h-12 w-12 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl text-slate-200 font-semibold">Unearthing Ancient Lore...</p>
      </div>
    </div>
  }

  <!-- Character Lore Modal -->
  @if (selectedCharacterLore(); as lore) {
    <div class="fixed inset-0 bg-white/80 dark:bg-slate-900/90 backdrop-blur-sm z-[60] animate-fade-in-fast" (click)="closeCharacterLore()"></div>
    <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl w-full max-w-4xl max-h-[90vh] shadow-2xl shadow-purple-500/10 flex flex-col animate-fade-in-up">
        <header class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
          <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-rose-500 dark:from-purple-400 dark:to-rose-400">
            Lore of {{ lore.name }}
          </h2>
          <button (click)="closeCharacterLore()" class="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors" aria-label="Close lore">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </header>
        <main class="p-6 sm:p-8 overflow-y-auto text-slate-600 dark:text-slate-300">
          <p class="leading-relaxed whitespace-pre-wrap">{{ lore.lore }}</p>
          
          @if (lore.sources && lore.sources.length > 0) {
            <div class="mt-8">
              <h3 class="text-xl font-semibold text-purple-600 dark:text-purple-400 mb-3">Sources</h3>
              <ul class="list-disc list-inside space-y-2 text-slate-600 dark:text-slate-300">
                @for(source of lore.sources; track source.web.uri) {
                  <li>
                    <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="text-indigo-500 dark:text-indigo-400 hover:underline break-words">{{ source.web.title || source.web.uri }}</a>
                  </li>
                }
              </ul>
            </div>
          }
        </main>
      </div>
    </div>
  }

  <!-- Character Profile Loading State -->
  @if (isProfileLoading()) {
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center animate-fade-in-fast">
      <div class="flex flex-col items-center gap-4">
        <svg class="animate-spin h-12 w-12 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-xl text-slate-200 font-semibold">Accessing Cosmic Archives...</p>
      </div>
    </div>
  }

  <!-- Character Profile Modal -->
  @if (selectedCharacterProfile(); as profile) {
    <app-character-profile 
      [characterProfile]="profile" 
      (close)="closeCharacterProfile()"
      [imageStyle]="imageStyle()"
      [imageMood]="imageMood()">
    </app-character-profile>
  }

  <!-- Image Editor Modal -->
  @if (editingImageData(); as editData) {
    <app-image-editor 
      [editData]="editData" 
      (close)="closeImageEditor()" 
      (imageUpdated)="handleImageUpdate($event)">
    </app-image-editor>
  }

  <!-- Lore Connections Modal -->
  @if (exploringLoreConnection()) {
      <div class="fixed inset-0 bg-white/80 dark:bg-slate-900/90 backdrop-blur-sm z-[60] animate-fade-in-fast" (click)="closeLoreConnection()"></div>
      <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl w-full max-w-4xl max-h-[90vh] shadow-2xl shadow-indigo-500/10 flex flex-col animate-fade-in-up">
          <header class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-cyan-500 dark:from-indigo-400 dark:to-cyan-400">
              Lore Connections
            </h2>
            <button (click)="closeLoreConnection()" class="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors" aria-label="Close lore connections">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </header>

          <main class="p-6 sm:p-8 overflow-y-auto text-slate-600 dark:text-slate-300">
            @if (isLoreConnectionLoading()) {
              <div class="flex flex-col items-center justify-center gap-4 py-16">
                <svg class="animate-spin h-12 w-12 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-xl text-slate-500 dark:text-slate-400 font-semibold">Analyzing cosmic strings...</p>
              </div>
            } @else if (loreConnectionError(); as errorMessage) {
              <div class="bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-500 text-red-700 dark:text-red-300 p-4 rounded-lg text-center">
                <p class="font-bold">Error Analyzing Connections</p>
                <p>{{ errorMessage }}</p>
              </div>
            } @else if (loreConnectionData(); as loreData) {
              <div class="animate-fade-in-fast">
                <div class="text-center mb-6">
                  <p class="text-lg font-semibold">{{ fighter1() }} <span class="text-indigo-400">&</span> {{ fighter2() }}</p>
                </div>

                <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700 mb-8">
                  <h3 class="text-xl font-semibold text-cyan-600 dark:text-cyan-400 mb-2">Analysis Summary</h3>
                  <p class="leading-relaxed">{{ loreData.summary }}</p>
                  @if(loreData.connectionExists && loreData.sharedUniverse) {
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                      <span class="font-semibold">Shared Universe:</span> {{ loreData.sharedUniverse }}
                    </p>
                  }
                </div>

                @if (loreData.connectionExists) {
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Shared Allies -->
                    <div class="flex flex-col">
                      <h4 class="text-lg font-bold text-green-500 dark:text-green-400 mb-3 text-center">Shared Allies</h4>
                      <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 flex-grow">
                        @if (loreData.sharedAllies && loreData.sharedAllies.length > 0) {
                          <ul class="space-y-3">
                            @for (ally of loreData.sharedAllies; track ally.name) {
                              <li>
                                <p class="font-semibold text-slate-800 dark:text-slate-200">{{ ally.name }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 italic">{{ ally.relationship }}</p>
                              </li>
                            }
                          </ul>
                        } @else {
                          <p class="text-center text-slate-500 dark:text-slate-400 text-sm py-4">No significant shared allies found.</p>
                        }
                      </div>
                    </div>

                    <!-- Shared Enemies -->
                    <div class="flex flex-col">
                      <h4 class="text-lg font-bold text-red-500 dark:text-red-400 mb-3 text-center">Shared Enemies</h4>
                       <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 flex-grow">
                        @if (loreData.sharedEnemies && loreData.sharedEnemies.length > 0) {
                          <ul class="space-y-3">
                            @for (enemy of loreData.sharedEnemies; track enemy.name) {
                              <li>
                                <p class="font-semibold text-slate-800 dark:text-slate-200">{{ enemy.name }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400 italic">{{ enemy.relationship }}</p>
                              </li>
                            }
                          </ul>
                        } @else {
                          <p class="text-center text-slate-500 dark:text-slate-400 text-sm py-4">No significant shared enemies found.</p>
                        }
                      </div>
                    </div>

                    <!-- Key Events -->
                    <div class="flex flex-col md:col-span-2 lg:col-span-1">
                      <h4 class="text-lg font-bold text-amber-500 dark:text-amber-400 mb-3 text-center">Key Events</h4>
                       <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 flex-grow">
                        @if (loreData.keyEvents && loreData.keyEvents.length > 0) {
                          <ul class="space-y-3">
                            @for (event of loreData.keyEvents; track event.event) {
                              <li>
                                <p class="font-semibold text-slate-800 dark:text-slate-200">{{ event.event }}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">{{ event.description }}</p>
                              </li>
                            }
                          </ul>
                        } @else {
                          <p class="text-center text-slate-500 dark:text-slate-400 text-sm py-4">No significant shared events found.</p>
                        }
                      </div>
                    </div>
                  </div>
                }

                @if (loreData.sources && loreData.sources.length > 0) {
                  <div>
                    <h3 class="text-xl font-semibold text-cyan-600 dark:text-cyan-400 mb-3">Sources</h3>
                    <ul class="list-disc list-inside space-y-2 text-slate-600 dark:text-slate-300">
                      @for(source of loreData.sources; track source.web.uri) {
                        <li>
                          <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="text-indigo-500 dark:text-indigo-400 hover:underline break-words">{{ source.web.title || source.web.uri }}</a>
                        </li>
                      }
                    </ul>
                  </div>
                }
              </div>
            }
          </main>
        </div>
      </div>
  }


  <!-- Profile Error Toast -->
  @if (profileError(); as error) {
    <div class="fixed bottom-6 right-6 bg-red-600 text-white p-4 rounded-lg shadow-2xl z-[70] animate-fade-in-up">
      <p class="font-bold">Profile Error</p>
      <p>{{ error }}</p>
    </div>
  }

  <!-- Character Lore Error Toast -->
  @if (characterLoreError(); as error) {
    <div class="fixed bottom-6 right-6 bg-rose-600 text-white p-4 rounded-lg shadow-2xl z-[70] animate-fade-in-up">
      <p class="font-bold">Lore Error</p>
      <p>{{ error }}</p>
    </div>
  }

  <!-- MAIN CONTENT -->
  <main 
    class="min-h-screen font-sans p-4 sm:p-6 md:p-8 transition-colors duration-500"
    [class.dark]="theme() === 'dark'"
    [class]="theme() === 'dark' ? pathThemeClasses() : lightPathThemeClasses()">

    <div class="max-w-6xl mx-auto">
      
      <!-- Header -->
      <header class="text-center mb-8 relative">
        <h1 
          class="text-4xl sm:text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r pb-2 transition-all duration-500"
          [class]="theme() === 'dark' ? pathHeaderTextClasses() : lightPathHeaderTextClasses()">
          Cosmic Clash
        </h1>
        <p 
          class="text-lg transition-colors duration-500"
          [class.text-slate-500]="theme() === 'light'"
          [class.text-slate-400]="theme() === 'dark'">AI Battle Simulator</p>
        
        <div class="absolute top-0 right-0 flex items-center gap-2">
          <button (click)="toggleTheme()" class="p-2 rounded-full transition-colors" [attr.aria-label]="'Switch to ' + (theme() === 'dark' ? 'light' : 'dark') + ' mode'"
            [class.text-slate-500]="theme() === 'light'" [class.hover:text-cyan-500]="theme() === 'light'" [class.hover:bg-slate-200]="theme() === 'light'"
            [class.text-slate-400]="theme() === 'dark'" [class.hover:text-cyan-400]="theme() === 'dark'" [class.hover:bg-slate-800]="theme() === 'dark'">
            @if(theme() === 'dark') {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>
            }
          </button>
          <button (click)="toggleHistory()" class="p-2 rounded-full transition-colors" aria-label="View Battle History"
            [class.text-slate-500]="theme() === 'light'" [class.hover:text-cyan-500]="theme() === 'light'" [class.hover:bg-slate-200]="theme() === 'light'"
            [class.text-slate-400]="theme() === 'dark'" [class.hover:text-cyan-400]="theme() === 'dark'" [class.hover:bg-slate-800]="theme() === 'dark'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
          </button>
          <button (click)="openAbout()" class="p-2 rounded-full transition-colors" aria-label="About Cosmic Clash"
            [class.text-slate-500]="theme() === 'light'" [class.hover:text-cyan-500]="theme() === 'light'" [class.hover:bg-slate-200]="theme() === 'light'"
            [class.text-slate-400]="theme() === 'dark'" [class.hover:text-cyan-400]="theme() === 'dark'" [class.hover:bg-slate-800]="theme() === 'dark'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>
          </button>
        </div>
      </header>

      <!-- Fighter Inputs -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 items-start">
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-2">
            <label for="fighter1" class="text-lg font-semibold text-slate-700 dark:text-slate-300">Challenger 1</label>
            @if (fighter1().trim()) {
              <button (click)="showCharacterInfo(fighter1())" [disabled]="isProfileLoading()" class="text-slate-400 hover:text-cyan-500 dark:hover:text-cyan-400 transition-colors disabled:opacity-50 disabled:cursor-wait" [attr.aria-label]="'Get info for ' + fighter1()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </button>
              <button (click)="showCharacterLore(fighter1())" [disabled]="isCharacterLoreLoading()" class="text-slate-400 hover:text-purple-500 dark:hover:text-purple-400 transition-colors disabled:opacity-50 disabled:cursor-wait" [attr.aria-label]="'Get lore for ' + fighter1()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M2 4.75A2.75 2.75 0 0 1 4.75 2h10.5A2.75 2.75 0 0 1 18 4.75v10.5A2.75 2.75 0 0 1 15.25 18H4.75A2.75 2.75 0 0 1 2 15.25V4.75Zm3.5-1.5a.75.75 0 0 0-1.5 0v11.5a.75.75 0 0 0 1.5 0V3.25Zm2.75-.75a.75.75 0 0 0-1.5 0v13.5a.75.75 0 0 0 1.5 0V2.5Z" clip-rule="evenodd" /></svg>
              </button>
            }
          </div>
          <div class="relative">
            <input id="fighter1" type="text" [value]="fighter1()" (input)="updateFighter($event, 1)" (blur)="validateFighter(fighter1, fighter1Error)" placeholder="e.g., Superman (Post-Crisis)" class="w-full bg-slate-200 dark:bg-slate-800 border-2 rounded-lg p-3 pr-10 text-slate-900 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all duration-300" [class.border-slate-300]="!fighter1Error()" [class.dark:border-slate-700]="!fighter1Error()" [class.focus:border-indigo-500]="!fighter1Error()" [class.border-red-500]="fighter1Error()" [class.focus:border-red-500]="fighter1Error()" [class.focus:ring-red-500]="fighter1Error()" />
            @if (fighter1().trim()) {
              <button (click)="clearFighter(1)" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-red-500 transition-colors" aria-label="Clear Challenger 1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
              </button>
            }
          </div>
          @if (fighter1Error(); as error) {
            <div class="flex items-center gap-1.5 text-red-500 dark:text-red-400 text-sm mt-1 px-1 animate-fade-in-fast">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
              <p>{{ error }}</p>
            </div>
          }
          <div class="min-h-[5.5rem] mt-1 px-1">
            @if(isFetchingFighter1Tier()) {
              <div class="flex items-center gap-2 text-slate-400 dark:text-slate-500 animate-fade-in-fast"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-sm">Analyzing tier...</span></div>
            } @else if (fighter1TierInfo(); as tierInfo) {
              <div class="bg-slate-100 dark:bg-slate-800/50 p-2 rounded-md animate-fade-in-fast border border-slate-200 dark:border-slate-700 space-y-1.5">
                <div class="relative group w-fit cursor-help">
                  <div class="flex items-center gap-2">
                    <span 
                      class="px-2 py-0.5 rounded-md text-xs font-bold border"
                      [class]="getTierBadgeClasses(tierInfo.tierValue)">
                      {{ tierInfo.tier }}
                    </span>
                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">{{ tierInfo.tierName }}</p>
                  </div>
                  <div class="absolute bottom-full mb-2 w-72 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs text-center rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    {{ getTierDescription(tierInfo.tierValue) }}
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-900"></div>
                  </div>
                </div>
                @if (fighter1HasHax()) {
                  <div class="relative group w-fit">
                    <div class="flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 border border-red-300 dark:border-red-600/50 cursor-help">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.852-1.21 3.488 0l6.064 11.587a2 2 0 01-1.744 2.973H3.937a2 2 0 01-1.744-2.973L8.257 3.099zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-5a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                      <span>Tier-Negating Abilities</span>
                    </div>
                    <div class="absolute top-full text-left mt-2 w-96 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                      <div class="space-y-3">
                        @let powerNull = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Power Nullification');
                        @if (powerNull.length > 0) {
                          <div>
                            <h4 class="font-bold text-cyan-400">Power Nullification</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of powerNull; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                        @let resistanceNeg = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Resistance Negation');
                        @if (resistanceNeg.length > 0) {
                          <div>
                            <h4 class="font-bold text-rose-400">Resistance Negation</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of resistanceNeg; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                        @let realityNeg = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Causality and Reality Negation');
                        @if (realityNeg.length > 0) {
                          <div>
                            <h4 class="font-bold text-amber-400">Causality & Reality Negation</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of realityNeg; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                      </div>
                      <div class="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-b-4 border-b-slate-900"></div>
                    </div>
                  </div>
                }
                <p class="text-xs text-slate-500 dark:text-slate-400 italic !mt-1">{{ tierInfo.justification }}</p>
                @if (tierInfo.sources && tierInfo.sources.length > 0) {
                  <div class="mt-2 text-xs text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 pt-1">
                    <span class="font-semibold">Sources:</span>
                    @for(source of tierInfo.sources; track source.web.uri; let isLast = $last) {
                      <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="hover:underline">{{ source.web.title || 'link' }}</a>{{ !isLast ? ', ' : '' }}
                    }
                  </div>
                }
              </div>
            } @else if (fighter1TierError(); as error) {
               <div class="bg-red-100 dark:bg-red-900/30 p-2 rounded-md animate-fade-in-fast border border-red-200 dark:border-red-700/50 text-red-600 dark:text-red-400 text-xs">
                <p class="font-semibold">Tier Analysis Failed</p>
                <p>{{ error }}</p>
              </div>
            }
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-2">
            <label for="fighter2" class="text-lg font-semibold text-slate-700 dark:text-slate-300">Challenger 2</label>
            @if (fighter2().trim()) {
              <button (click)="showCharacterInfo(fighter2())" [disabled]="isProfileLoading()" class="text-slate-400 hover:text-cyan-500 dark:hover:text-cyan-400 transition-colors disabled:opacity-50 disabled:cursor-wait" [attr.aria-label]="'Get info for ' + fighter2()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
              </button>
              <button (click)="showCharacterLore(fighter2())" [disabled]="isCharacterLoreLoading()" class="text-slate-400 hover:text-purple-500 dark:hover:text-purple-400 transition-colors disabled:opacity-50 disabled:cursor-wait" [attr.aria-label]="'Get lore for ' + fighter2()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M2 4.75A2.75 2.75 0 0 1 4.75 2h10.5A2.75 2.75 0 0 1 18 4.75v10.5A2.75 2.75 0 0 1 15.25 18H4.75A2.75 2.75 0 0 1 2 15.25V4.75Zm3.5-1.5a.75.75 0 0 0-1.5 0v11.5a.75.75 0 0 0 1.5 0V3.25Zm2.75-.75a.75.75 0 0 0-1.5 0v13.5a.75.75 0 0 0 1.5 0V2.5Z" clip-rule="evenodd" /></svg>
              </button>
            }
          </div>
          <div class="relative">
            <input id="fighter2" type="text" [value]="fighter2()" (input)="updateFighter($event, 2)" (blur)="validateFighter(fighter2, fighter2Error)" placeholder="e.g., Goku (Ultra Instinct)" class="w-full bg-slate-200 dark:bg-slate-800 border-2 rounded-lg p-3 pr-10 text-slate-900 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all duration-300" [class.border-slate-300]="!fighter2Error()" [class.dark:border-slate-700]="!fighter2Error()" [class.focus:border-indigo-500]="!fighter2Error()" [class.border-red-500]="fighter2Error()" [class.focus:border-red-500]="fighter2Error()" [class.focus:ring-red-500]="fighter2Error()" />
            @if (fighter2().trim()) {
              <button (click)="clearFighter(2)" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-red-500 transition-colors" aria-label="Clear Challenger 2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
              </button>
            }
          </div>
          @if (fighter2Error(); as error) {
            <div class="flex items-center gap-1.5 text-red-500 dark:text-red-400 text-sm mt-1 px-1 animate-fade-in-fast">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
              <p>{{ error }}</p>
            </div>
          }
          <div class="min-h-[5.5rem] mt-1 px-1">
            @if(isFetchingFighter2Tier()) {
              <div class="flex items-center gap-2 text-slate-400 dark:text-slate-500 animate-fade-in-fast"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-sm">Analyzing tier...</span></div>
            } @else if (fighter2TierInfo(); as tierInfo) {
              <div class="bg-slate-100 dark:bg-slate-800/50 p-2 rounded-md animate-fade-in-fast border border-slate-200 dark:border-slate-700 space-y-1.5">
                <div class="relative group w-fit cursor-help">
                  <div class="flex items-center gap-2">
                    <span 
                      class="px-2 py-0.5 rounded-md text-xs font-bold border"
                      [class]="getTierBadgeClasses(tierInfo.tierValue)">
                      {{ tierInfo.tier }}
                    </span>
                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">{{ tierInfo.tierName }}</p>
                  </div>
                  <div class="absolute bottom-full mb-2 w-72 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs text-center rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                    {{ getTierDescription(tierInfo.tierValue) }}
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-900"></div>
                  </div>
                </div>
                @if (fighter2HasHax()) {
                  <div class="relative group w-fit">
                    <div class="flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 border border-red-300 dark:border-red-600/50 cursor-help">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.852-1.21 3.488 0l6.064 11.587a2 2 0 01-1.744 2.973H3.937a2 2 0 01-1.744-2.973L8.257 3.099zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-5a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                      <span>Tier-Negating Abilities</span>
                    </div>
                    <div class="absolute top-full text-left mt-2 w-96 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                      <div class="space-y-3">
                        @let powerNull = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Power Nullification');
                        @if (powerNull.length > 0) {
                          <div>
                            <h4 class="font-bold text-cyan-400">Power Nullification</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of powerNull; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                        @let resistanceNeg = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Resistance Negation');
                        @if (resistanceNeg.length > 0) {
                          <div>
                            <h4 class="font-bold text-rose-400">Resistance Negation</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of resistanceNeg; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                        @let realityNeg = getAbilitiesByCategory(tierInfo.tierNegatingAbilities, 'Causality and Reality Negation');
                        @if (realityNeg.length > 0) {
                          <div>
                            <h4 class="font-bold text-amber-400">Causality & Reality Negation</h4>
                            <ul class="list-disc list-inside pl-2 space-y-1 mt-1 text-slate-300">
                              @for (ability of realityNeg; track $index) {
                                <li><span class="font-semibold text-white">{{ ability.type }}:</span> {{ ability.description }}</li>
                              }
                            </ul>
                          </div>
                        }
                      </div>
                      <div class="absolute bottom-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-b-4 border-b-slate-900"></div>
                    </div>
                  </div>
                }
                <p class="text-xs text-slate-500 dark:text-slate-400 italic !mt-1">{{ tierInfo.justification }}</p>
                @if (tierInfo.sources && tierInfo.sources.length > 0) {
                  <div class="mt-2 text-xs text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 pt-1">
                    <span class="font-semibold">Sources:</span>
                    @for(source of tierInfo.sources; track source.web.uri; let isLast = $last) {
                      <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="hover:underline">{{ source.web.title || 'link' }}</a>{{ !isLast ? ', ' : '' }}
                    }
                  </div>
                }
              </div>
            } @else if (fighter2TierError(); as error) {
               <div class="bg-red-100 dark:bg-red-900/30 p-2 rounded-md animate-fade-in-fast border border-red-200 dark:border-red-700/50 text-red-600 dark:text-red-400 text-xs">
                <p class="font-semibold">Tier Analysis Failed</p>
                <p>{{ error }}</p>
              </div>
            }
          </div>
        </div>
      </section>

      <!-- Battle Options -->
      <div class="bg-white/50 dark:bg-slate-800/50 rounded-2xl p-6 mb-6 border border-slate-200 dark:border-slate-700 shadow-lg">
        <h3 class="text-xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">Image Generation Options</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          <!-- Aspect Ratio -->
          <div class="flex flex-col items-center">
            <label for="aspectRatio" class="block text-base font-semibold text-slate-600 dark:text-slate-300 mb-3">Aspect Ratio</label>
            <select id="aspectRatio" [value]="aspectRatio()" (change)="aspectRatio.set($any($event.target).value)" class="w-full max-w-xs bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-indigo-500 outline-none transition text-center font-medium">
              @for(ratio of aspectRatios; track ratio) {
                <option [value]="ratio">{{ ratio }}</option>
              }
            </select>
          </div>

          <!-- Image Style -->
          <div class="flex flex-col items-center">
            <label class="block text-base font-semibold text-slate-600 dark:text-slate-300 mb-3">Image Style</label>
            <div class="flex flex-wrap justify-center gap-2">
              @for(style of imageStyles; track style.id) {
                <button 
                  type="button"
                  (click)="imageStyle.set(style.id)"
                  class="px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 border-2"
                  [class.bg-indigo-600]="imageStyle() === style.id"
                  [class.text-white]="imageStyle() === style.id"
                  [class.border-indigo-600]="imageStyle() === style.id"
                  [class.shadow-md]="imageStyle() === style.id"
                  [class.shadow-indigo-500/50]="imageStyle() === style.id"
                  [class.bg-slate-200]="imageStyle() !== style.id"
                  [class.dark:bg-slate-700]="imageStyle() !== style.id"
                  [class.text-slate-700]="imageStyle() !== style.id"
                  [class.dark:text-slate-300]="imageStyle() !== style.id"
                  [class.border-transparent]="imageStyle() !== style.id"
                  [class.hover:border-indigo-500]="imageStyle() !== style.id"
                  [class.hover:text-indigo-600]="imageStyle() !== style.id"
                  [class.dark:hover:text-indigo-400]="imageStyle() !== style.id">
                  {{ style.label }}
                </button>
              }
            </div>
          </div>
          
          <!-- Image Mood -->
          <div class="flex flex-col items-center">
            <label class="block text-base font-semibold text-slate-600 dark:text-slate-300 mb-3">Image Mood</label>
            <div class="flex flex-wrap justify-center gap-2">
              @for(mood of imageMoods; track mood.id) {
                <button 
                  type="button"
                  (click)="imageMood.set(mood.id)"
                  class="px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 border-2"
                  [class.bg-purple-600]="imageMood() === mood.id"
                  [class.text-white]="imageMood() === mood.id"
                  [class.border-purple-600]="imageMood() === mood.id"
                  [class.shadow-md]="imageMood() === mood.id"
                  [class.shadow-purple-500/50]="imageMood() === mood.id"
                  [class.bg-slate-200]="imageMood() !== mood.id"
                  [class.dark:bg-slate-700]="imageMood() !== mood.id"
                  [class.text-slate-700]="imageMood() !== mood.id"
                  [class.dark:text-slate-300]="imageMood() !== mood.id"
                  [class.border-transparent]="imageMood() !== mood.id"
                  [class.hover:border-purple-500]="imageMood() !== mood.id"
                  [class.hover:text-purple-600]="imageMood() !== mood.id"
                  [class.dark:hover:text-purple-400]="imageMood() !== mood.id">
                  {{ mood.label }}
                </button>
              }
            </div>
          </div>
          
        </div>
      </div>

      <!-- Battle Button -->
      <div class="text-center mb-8 h-24 flex flex-col justify-center items-center">
        <div class="flex items-center justify-center gap-4">
          @if (isLoading()) {
            <div 
              class="text-2xl font-bold px-10 py-4 rounded-lg bg-gradient-to-r text-white/80 shadow-inner opacity-75 cursor-wait"
              [class]="theme() === 'dark' ? pathButtonClasses() : lightPathButtonClasses()">
              <span>SIMULATING...</span>
            </div>
            <button (click)="cancelBattle()" class="text-xl font-bold px-8 py-4 rounded-lg bg-red-600 text-white shadow-lg shadow-red-500/40 hover:bg-red-700 transform hover:scale-105 transition-all">
              Cancel
            </button>
          } @else {
            <button (click)="startBattle()" [disabled]="!isBattleReady() || cooldown() > 0" class="text-2xl font-bold px-10 py-4 rounded-lg bg-gradient-to-r text-white shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100 disabled:shadow-none" [class]="theme() === 'dark' ? pathButtonClasses() : lightPathButtonClasses()">
              @if (cooldown() > 0) {
                <span>RECHARGING... ({{ cooldown() }}s)</span>
              } @else {
                <span>BATTLE!</span>
              }
            </button>
            <button (click)="getRandomBattle()" [disabled]="isLoading() || isGettingRandom()" class="p-4 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 shadow-md hover:bg-slate-300 dark:hover:bg-slate-600 transform hover:scale-105 transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-wait disabled:scale-100 disabled:shadow-none" aria-label="Get Random Battle">
              @if (isGettingRandom()) {
                <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691v4.992h-4.992m0 0-3.181-3.183a8.25 8.25 0 0 1 11.667 0l3.181 3.183" /></svg>
              }
            </button>
          }
        </div>

        @if (battlePath() !== BattlePath.PENDING && !isLoading()) {
          <div class="mt-4 text-center text-sm px-4 py-2 rounded-md max-w-lg mx-auto" 
            [class.bg-red-500/10]="battlePath() === BattlePath.MISMATCH" [class.text-red-400]="battlePath() === BattlePath.MISMATCH"
            [class.bg-green-500/10]="battlePath() !== BattlePath.MISMATCH && battlePath() !== BattlePath.BOUNDLESS" [class.text-green-400]="battlePath() !== BattlePath.MISMATCH && battlePath() !== BattlePath.BOUNDLESS"
            [class.bg-amber-500/10]="battlePath() === BattlePath.BOUNDLESS" [class.text-amber-300]="battlePath() === BattlePath.BOUNDLESS">

            @switch (battlePath()) {
              @case (BattlePath.MISMATCH) { <p><strong>Power Mismatch:</strong> These fighters are in different battle paths and lack tier-negating abilities for a fair fight.</p> }
              @case (BattlePath.BOUNDLESS) { <p><strong>Warning:</strong> Tier 0 battles are highly subjective and UNLIKELY TO HAPPEN. The result is a theoretical analysis of omnipotent concepts.</p> }
              @default { <p><strong>Battle Path:</strong> {{ battlePath() }}</p> }
            }
          </div>
        }
      </div>

      <!-- Loading State -->
      @if (isLoading()) {
        <div class="text-center p-8 flex flex-col items-center justify-center gap-6">
          <div class="w-full max-w-md bg-slate-300 dark:bg-slate-700 rounded-full h-3 animate-progress-bar" [style.--progress-bar-start]="pathHeaderTextClasses().split(' ')[0].replace('from-','')" [style.--progress-bar-end]="pathHeaderTextClasses().split(' ')[1].replace('to-','')"></div>
          <p class="text-xl text-slate-500 dark:text-slate-400 font-semibold">{{ currentLoadingMessage() }}</p>
        </div>
      }

      <!-- Error State -->
      @if (error()) {
        <div class="bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-500 text-red-700 dark:text-red-300 p-4 rounded-lg text-center">
          <p class="font-bold">Error</p>
          <p>{{ error() }}</p>
        </div>
      }

      <!-- Result Display -->
      @if (battleResult(); as result) {
        <section class="animate-fade-in-up flex flex-col md:flex-row gap-6 lg:gap-8">
          
          <!-- Sidebar Navigation -->
          <nav class="flex-shrink-0 md:w-56 bg-slate-100 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 self-start md:sticky top-8">
            <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200 px-2">Analysis Sections</h3>
            <ul class="space-y-2">
              <li><button (click)="setView('summary')" class="nav-button" [class.nav-active]="activeView() === 'summary'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M2.5 3A1.5 1.5 0 0 0 1 4.5v11A1.5 1.5 0 0 0 2.5 17h15a1.5 1.5 0 0 0 1.5-1.5v-11A1.5 1.5 0 0 0 17.5 3h-15Zm11.25 11.5a.75.75 0 0 1 0-1.5h.25a.75.75 0 0 1 0 1.5h-.25ZM12 11.25a.75.75 0 0 0-.75.75v.25a.75.75 0 0 0 1.5 0v-.25a.75.75 0 0 0-.75-.75ZM10.75 13a.75.75 0 0 1 0-1.5h.25a.75.75 0 0 1 0 1.5h-.25ZM10 7.25a.75.75 0 0 0-.75.75v5a.75.75 0 0 0 1.5 0v-5a.75.75 0 0 0-.75-.75ZM8.75 9a.75.75 0 0 1 0-1.5h.25a.75.75 0 0 1 0 1.5h-.25ZM8 6.25a.75.75 0 0 0-.75.75v6a.75.75 0 0 0 1.5 0v-6a.75.75 0 0 0-.75-.75ZM6.75 8a.75.75 0 0 1 0-1.5h.25a.75.75 0 0 1 0 1.5h-.25ZM6 9.25a.75.75 0 0 0-.75.75v2a.75.75 0 0 0 1.5 0v-2a.75.75 0 0 0-.75-.75ZM4.75 11a.75.75 0 0 1 0-1.5h.25a.75.75 0 0 1 0 1.5h-.25Z" clip-rule="evenodd" /></svg><span>Summary</span></button></li>
              <li><button (click)="setView('tier')" class="nav-button" [class.nav-active]="activeView() === 'tier'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10 3.5a.75.75 0 0 1 .75.75v1.5h1.5a.75.75 0 0 1 0 1.5h-1.5v1.5a.75.75 0 0 1-1.5 0v-1.5h-1.5a.75.75 0 0 1 0-1.5h1.5v-1.5a.75.75 0 0 1 .75-.75Z" /><path fill-rule="evenodd" d="M8.421 2.222a.75.75 0 0 1 1.158 0l6.25 7.5a.75.75 0 0 1-.579 1.278H4.75a.75.75 0 0 1-.579-1.278l6.25-7.5ZM10 12.5a.75.75 0 0 1 .75.75v1.5h1.5a.75.75 0 0 1 0 1.5h-1.5v1.5a.75.75 0 0 1-1.5 0v-1.5h-1.5a.75.75 0 0 1 0-1.5h1.5v-1.5A.75.75 0 0 1 10 12.5Z" clip-rule="evenodd" /></svg><span>Tier Comparison</span></button></li>
              <li><button (click)="setView('stats')" class="nav-button" [class.nav-active]="activeView() === 'stats'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M1 1.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-12Zm5 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-12Zm5 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-12Zm5 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v12a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-12Z" /></svg><span>Stats Breakdown</span></button></li>
              <li><button (click)="setView('analysis')" class="nav-button" [class.nav-active]="activeView() === 'analysis'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 2a.75.75 0 0 1 .75.75v.518a.75.75 0 0 1-.53.707l-1.5 1.5a.75.75 0 0 1-1.06 0l-1.5-1.5A.75.75 0 0 1 5.5 3.268V2.75A.75.75 0 0 1 6.25 2h3.5ZM3.5 6.25a.75.75 0 0 0 0 1.5h13a.75.75 0 0 0 0-1.5h-13ZM10 12.25a.75.75 0 0 1 .75.75v.518a.75.75 0 0 1-.53.707l-1.5 1.5a.75.75 0 0 1-1.06 0l-1.5-1.5a.75.75 0 0 1-.177-1.014L5.5 13.268V12.75a.75.75 0 0 1 .75-.75h3.5ZM10 8.25a.75.75 0 0 1 .75.75v.518a.75.75 0 0 1-.53.707l-1.5 1.5a.75.75 0 0 1-1.06 0l-1.5-1.5A.75.75 0 0 1 5.5 9.518V9a.75.75 0 0 1 .75-.75h3.5Z" clip-rule="evenodd" /></svg><span>Detailed Analysis</span></button></li>
              <li><button (click)="setView('sources')" class="nav-button" [class.nav-active]="activeView() === 'sources'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z" /><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 0 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z" /></svg><span>Sources</span></button></li>
            </ul>
            <hr class="my-4 border-slate-200 dark:border-slate-600/50">
            <button (click)="exportResults()" class="nav-button">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
              <span>Export Results</span>
            </button>
          </nav>
          
          <!-- Main Content View -->
          <div class="flex-1 min-w-0">
            @switch (activeView()) {
              @case ('summary') {
                <div class="animate-fade-in-up">
                  @if (result.fighter1 && result.fighter2) {
                    <!-- Character Images -->
                    <div class="grid grid-cols-2 gap-4 md:gap-8 mb-8">
                      <!-- Fighter 1 -->
                      <div class="flex flex-col items-center gap-2">
                        <div class="w-full relative group rounded-xl shadow-lg transition-all" [class]="result.winner === result.fighter1.name ? pathWinnerBorderClasses() + ' border-4' : 'border-4 border-transparent'" [style.aspect-ratio]="imageAspectRatioStyle()">
                          <div class="absolute inset-0 bg-slate-200 dark:bg-slate-700 animate-pulse rounded-lg"></div>
                          @if (fighter1Image(); as imgUrl) {
                            <img [src]="imgUrl" [alt]="'Image of ' + result.fighter1.name" class="absolute inset-0 w-full h-full rounded-lg object-cover transition-all duration-500" [class.grayscale]="result.winner !== result.fighter1.name">
                          }
                          @if (result.winner !== result.fighter1.name) {
                            <div class="absolute inset-0 bg-black/40 rounded-lg group-hover:bg-black/30 transition-colors"></div>
                          }
                          @if (fighter1Image()) {
                            <button (click)="openImageEditor(1)" class="absolute bottom-3 right-3 z-10 bg-slate-800/60 backdrop-blur-sm text-white rounded-full p-2.5 hover:bg-slate-900/80 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 transform group-hover:scale-100 scale-90" [attr.aria-label]="'Edit image for ' + result.fighter1.name">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                          }
                        </div>
                        <div class="text-center">
                           <h4 class="text-2xl md:text-3xl font-bold text-center">{{ result.fighter1.name }}</h4>
                        </div>
                      </div>
                      <!-- Fighter 2 -->
                       <div class="flex flex-col items-center gap-2">
                        <div class="w-full relative group rounded-xl shadow-lg transition-all" [class]="result.winner === result.fighter2.name ? pathWinnerBorderClasses() + ' border-4' : 'border-4 border-transparent'" [style.aspect-ratio]="imageAspectRatioStyle()">
                          <div class="absolute inset-0 bg-slate-200 dark:bg-slate-700 animate-pulse rounded-lg"></div>
                          @if (fighter2Image(); as imgUrl) {
                            <img [src]="imgUrl" [alt]="'Image of ' + result.fighter2.name" class="absolute inset-0 w-full h-full rounded-lg object-cover transition-all duration-500" [class.grayscale]="result.winner !== result.fighter2.name">
                          }
                           @if (result.winner !== result.fighter2.name) {
                            <div class="absolute inset-0 bg-black/40 rounded-lg group-hover:bg-black/30 transition-colors"></div>
                          }
                          @if (fighter2Image()) {
                            <button (click)="openImageEditor(2)" class="absolute bottom-3 right-3 z-10 bg-slate-800/60 backdrop-blur-sm text-white rounded-full p-2.5 hover:bg-slate-900/80 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 transform group-hover:scale-100 scale-90" [attr.aria-label]="'Edit image for ' + result.fighter2.name">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                          }
                        </div>
                         <div class="text-center">
                          <h4 class="text-2xl md:text-3xl font-bold text-center">{{ result.fighter2.name }}</h4>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Winner Declaration -->
                    <div class="bg-slate-200/50 dark:bg-slate-800/50 border-2 rounded-xl p-6 text-center mb-8 shadow-2xl transition-all duration-500" [class]="pathWinnerBorderClasses()">
                      <h2 class="text-2xl font-bold text-slate-600 dark:text-slate-400 mb-2">The Winner Is...</h2>
                      <p class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r transition-all duration-500 animate-gradient-text" [class]="theme() === 'dark' ? pathHeaderTextClasses() : lightPathHeaderTextClasses()">
                        <button (click)="showCharacterInfo(result.winner)" class="hover:underline focus:outline-none focus:underline transition-all duration-200">
                          {{ result.winner }}
                        </button>
                      </p>
                      <div class="mt-4 relative group cursor-help">
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-sm font-semibold transition" [class]="confidenceClasses()">
                          <span>Confidence: {{ result.confidence }} ({{ result.confidenceScore }}/100)</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div class="absolute bottom-full mb-2 w-72 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-lg">
                          {{ result.confidenceJustification }}
                          <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-slate-900"></div>
                        </div>
                      </div>
                    </div>

                    <!-- Verdict Summary -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl p-6 mb-8 border border-slate-200 dark:border-slate-700">
                      <h3 class="text-2xl font-bold mb-3 transition-colors duration-500" [class]="theme() === 'dark' ? pathHeaderTextClasses().split(' ')[1].replace('to-', 'text-') : lightPathHeaderTextClasses().split(' ')[1].replace('to-', 'text-')">Verdict Summary</h3>
                      <p class="text-slate-600 dark:text-slate-300 leading-relaxed animate-text-focus-in">{{ result.verdictSummary }}</p>
                    </div>
                    
                    <!-- NLF Considerations -->
                    @if (result.nlfConsiderations) {
                      <div class="bg-amber-50 dark:bg-amber-900/40 rounded-xl p-6 mb-8 border border-amber-300 dark:border-amber-600/50">
                        <div class="flex items-start gap-4">
                          <div class="flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500 dark:text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.852-1.21 3.488 0l6.064 11.587a2 2 0 01-1.744 2.973H3.937a2 2 0 01-1.744-2.973L8.257 3.099zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-5a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                          </div>
                          <div>
                            <h3 class="text-xl font-bold mb-2 text-amber-800 dark:text-amber-300">Analysis Note: Avoiding "No Limits Fallacy"</h3>
                            <p class="text-amber-700 dark:text-amber-300/90 leading-relaxed">{{ result.nlfConsiderations }}</p>
                          </div>
                        </div>
                      </div>
                    }

                    <!-- Lore Connections Button -->
                    <div class="text-center mb-8">
                      <button (click)="exploreLoreConnection()" class="px-6 py-3 rounded-lg font-semibold bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 transition-all transform hover:scale-105 shadow-md">
                          <div class="flex items-center gap-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                              <span>Explore Lore Connections</span>
                          </div>
                      </button>
                    </div>
                  }
                </div>
              }
              @case ('tier') {
                <div class="animate-fade-in-up">
                  @if (fighter1TierInfo() && fighter2TierInfo() && result.fighter1 && result.fighter2) {
                    <app-tier-comparison
                      [fighter1Tier]="fighter1TierInfo()!"
                      [fighter2Tier]="fighter2TierInfo()!"
                      [fighter1Name]="result.fighter1.name"
                      [fighter2Name]="result.fighter2.name"
                      [theme]="theme()">
                    </app-tier-comparison>
                  }
                </div>
              }
              @case ('stats') {
                <div class="animate-fade-in-up">
                  @if (fighter1Data() && fighter2Data()) {
                    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 mb-8 overflow-hidden">
                      <div class="flex items-center border-b border-slate-200 dark:border-slate-700">
                        <button (click)="setActiveStatTab('chart')" class="flex-1 px-4 py-3 font-semibold text-base sm:text-lg transition-all duration-300" [class.-mb-px]="activeStatTab() === 'chart'" [class.text-indigo-500]="activeStatTab() === 'chart'" [class.dark:text-indigo-400]="activeStatTab() === 'chart'" [class.border-b-2]="activeStatTab() === 'chart'" [class.border-indigo-500]="activeStatTab() === 'chart'" [class.text-slate-500]="activeStatTab() !== 'chart'" [class.dark:text-slate-400]="activeStatTab() !== 'chart'" [class.hover:text-slate-800]="activeStatTab() !== 'chart'" [class.dark:hover:text-slate-200]="activeStatTab() !== 'chart'" [class.bg-slate-50]="activeStatTab() !== 'chart'" [class.dark:bg-slate-800/50]="activeStatTab() !== 'chart'">
                          Comparison Chart
                        </button>
                        <button (click)="setActiveStatTab('table')" class="flex-1 px-4 py-3 font-semibold text-base sm:text-lg transition-all duration-300" [class.-mb-px]="activeStatTab() === 'table'" [class.text-indigo-500]="activeStatTab() === 'table'" [class.dark:text-indigo-400]="activeStatTab() === 'table'" [class.border-b-2]="activeStatTab() === 'table'" [class.border-indigo-500]="activeStatTab() === 'table'" [class.text-slate-500]="activeStatTab() !== 'table'" [class.dark:text-slate-400]="activeStatTab() !== 'table'" [class.hover:text-slate-800]="activeStatTab() !== 'table'" [class.dark:hover:text-slate-200]="activeStatTab() !== 'table'" [class.bg-slate-50]="activeStatTab() !== 'table'" [class.dark:bg-slate-800/50]="activeStatTab() !== 'table'">
                          Breakdown Table
                        </button>
                      </div>
                      <div class="p-2 sm:p-4">
                        @if (activeStatTab() === 'chart') {
                          <div class="animate-fade-in-fast">
                            <app-stats-chart [fighter1]="fighter1Data()!" [fighter2]="fighter2Data()!" [theme]="theme()" (characterClick)="showCharacterInfo($event)"></app-stats-chart>
                          </div>
                        }
                        @if (activeStatTab() === 'table') {
                          <div class="animate-fade-in-fast p-2">
                            <table class="w-full text-center">
                                <thead>
                                  <tr class="border-b border-slate-200 dark:border-slate-700">
                                    <th class="p-3 font-semibold text-green-500 truncate">{{ result.fighter1?.name }}</th>
                                    <th class="p-3 font-semibold text-slate-500 dark:text-slate-400 uppercase text-sm tracking-wider">Stat</th>
                                    <th class="p-3 font-semibold text-blue-400 truncate">{{ result.fighter2?.name }}</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  @if(result.fighter1?.stats && result.fighter2?.stats) {
                                    @for(stat of statKeys; track stat) {
                                      <tr class="border-b border-slate-200 dark:border-slate-700 last:border-b-0">
                                        <td class="p-3 font-mono text-lg font-bold" [class.text-green-500]="result.fighter1.stats[stat] > result.fighter2.stats[stat]" [class.dark:text-green-400]="result.fighter1.stats[stat] > result.fighter2.stats[stat]" [class.text-slate-700]="result.fighter1.stats[stat] <= result.fighter2.stats[stat]" [class.dark:text-slate-200]="result.fighter1.stats[stat] <= result.fighter2.stats[stat]">
                                          {{ result.fighter1.stats[stat] }}
                                        </td>
                                        <td class="p-3 font-semibold capitalize text-slate-600 dark:text-slate-300">{{ formatStatName(stat) }}</td>
                                        <td class="p-3 font-mono text-lg font-bold" [class.text-blue-500]="result.fighter2.stats[stat] > result.fighter1.stats[stat]" [class.dark:text-blue-400]="result.fighter2.stats[stat] > result.fighter1.stats[stat]" [class.text-slate-700]="result.fighter2.stats[stat] <= result.fighter1.stats[stat]" [class.dark:text-slate-200]="result.fighter2.stats[stat] <= result.fighter1.stats[stat]">
                                          {{ result.fighter2.stats[stat] }}
                                        </td>
                                      </tr>
                                    }
                                  }
                                </tbody>
                                <tfoot>
                                  <tr class="border-t-2 border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50">
                                    <td class="p-3 font-mono text-xl font-bold" [class.text-green-500]="fighter1TotalStats() > fighter2TotalStats()" [class.dark:text-green-400]="fighter1TotalStats() > fighter2TotalStats()" [class.text-slate-700]="fighter1TotalStats() <= fighter2TotalStats()" [class.dark:text-slate-300]="fighter1TotalStats() <= fighter2TotalStats()">
                                      {{ fighter1TotalStats() }}
                                    </td>
                                    <td class="p-3 font-bold uppercase text-slate-600 dark:text-slate-300 tracking-wider">Total</td>
                                    <td class="p-3 font-mono text-xl font-bold" [class.text-blue-500]="fighter2TotalStats() > fighter1TotalStats()" [class.dark:text-blue-400]="fighter2TotalStats() > fighter1TotalStats()" [class.text-slate-700]="fighter2TotalStats() <= fighter1TotalStats()" [class.dark:text-slate-300]="fighter2TotalStats() <= fighter1TotalStats()">
                                      {{ fighter2TotalStats() }}
                                    </td>
                                  </tr>
                                </tfoot>
                              </table>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
              @case ('analysis') {
                <div class="animate-fade-in-up">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    @for (category of result.analysis | keyvalue; track category.key) {
                      <div class="bg-white dark:bg-slate-800 rounded-xl p-6 border border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-indigo-400 hover:shadow-lg hover:shadow-indigo-500/10 transition-all duration-300 transform hover:-translate-y-1 flex flex-col">
                        <div class="flex-grow">
                          <div class="flex items-center gap-3 mb-3">
                            @switch (category.key) {
                              @case ('strength') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-red-100 dark:bg-red-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-600 dark:text-red-400" viewBox="0 0 24 24" fill="currentColor"><path d="M7.5,2C5.71,2 4.5,3.21 4.5,5V6H3V15.5C3,17.43 4.57,19 6.5,19C7.5,19 8.35,18.61 9,18V17.5A2.5,2.5 0 0,0 6.5,15A2.5,2.5 0 0,0 9,12.5V12H10V11H12V12H13V9.5C13,7.57 14.57,6 16.5,6C18.43,6 20,7.57 20,9.5V11H21V2H19V3H17V2H15V3H13V2H10.5C10.5,2 10,2 9,3C8,4 7.5,3.79 7.5,2Z" /></svg>
                                </div>
                              }
                              @case ('speed') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-sky-100 dark:bg-sky-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-sky-600 dark:text-sky-400"><path d="M11.3 1.046A1 1 0 0 1 12 2v5h4a1 1 0 0 1 .82 1.573l-7 10A1 1 0 0 1 8 18v-5H4a1 1 0 0 1-.82-1.573l7-10a1 1 0 0 1 1.12-.38Z" /></svg>
                                </div>
                              }
                              @case ('durability') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-green-100 dark:bg-green-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-green-600 dark:text-green-400"><path d="M10 2L3 5v6c0 3.55 2.84 6.42 7 7c4.16-0.58 7-3.45 7-7V5l-7-3z" /></svg>
                                </div>
                              }
                              @case ('intelligence') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-indigo-100 dark:bg-indigo-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-600 dark:text-indigo-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A4,4 0 0,0 8,6C8,7.42 8.83,8.67 10,9.4V10H9V12H10V13H8V15H9V16A1,1 0 0,0 10,17H11A3,3 0 0,1 8,20A3,3 0 0,1 5,17A3,3 0 0,1 8,14V13H6V11H5V10H4V8H5A3,3 0 0,1 2,5A3,3 0 0,1 5,2A3,3 0 0,1 8,5V6.17C8.5,6.06 9.03,6 9.58,6H10V5H11V4H12M19,2A3,3 0 0,1 22,5A3,3 0 0,1 19,8H18V10H19V11H17V13H16V14A3,3 0 0,1 19,17A3,3 0 0,1 16,20A3,3 0 0,1 13,17H14V16H15V15H16V13H15V12H14V10H14.42C14.97,10 15.5,10.06 16,10.17V8A3,3 0 0,1 19,5A3,3 0 0,1 16,2H15V3H14V4H13V5H14C15.17,5.33 16,6.58 16,8V8.6C15.17,8.21 14.21,8 13.2,8H12V9H13V11H12V12H11V14H12V15A1,1 0 0,0 13,16H14A1,1 0 0,0 15,15V14H17V12H18V11H20V9H19C17.9,8.64 17,7.42 17,6A4,4 0 0,0 13,2H12V3H13V2H19Z" /></svg>
                                </div>
                              }
                              @case ('abilities') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-purple-100 dark:bg-purple-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-purple-600 dark:text-purple-400"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772.115-1.652-.479-2.246a1.5 1.5 0 0 0-2.459 1.595L8.232 6.5h-1.464a.75.75 0 0 0 0 1.5h1.464l-1.3 4.102-1.624-1.624a.75.75 0 1 0-1.06 1.06l2.75 2.75a.75.75 0 0 0 1.14-.114l1.5-2.25a.75.75 0 0 0-1.28-.853l-.868 1.299L10.332 7.5h1.464a.75.75 0 0 0 0-1.5h-1.464l.3-3.116Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.5 5.5a.75.75 0 0 0-.75-.75H14a.75.75 0 0 0 0 1.5h.75a.75.75 0 0 0 .75-.75ZM15.25 10a.75.75 0 0 1 .75.75v.75a.75.75 0 0 1-1.5 0v-.75a.75.75 0 0 1 .75-.75ZM12.5 15.5a.75.75 0 0 0-.75-.75H11a.75.75 0 0 0 0 1.5h.75a.75.75 0 0 0 .75-.75Z" clip-rule="evenodd" /></svg>
                                </div>
                              }
                              @case ('conclusion') {
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-amber-100 dark:bg-amber-900/50">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-amber-600 dark:text-amber-400"><path d="M15.5 2.5a3 3 0 0 0-1.898.705A3.001 3.001 0 0 0 12 4.5a3 3 0 0 0-1.602-1.295A3 3 0 0 0 8.5 2.5c-.83 0-1.594.34-2.162.903a2.5 2.5 0 0 1 4.324 0A2.988 2.988 0 0 0 12 4.5a2.988 2.988 0 0 0 1.338-.397 2.5 2.5 0 0 1 4.324 0A3 3 0 0 0 15.5 2.5Z" /><path fill-rule="evenodd" d="M2.502 8.5H3.02a1 1 0 0 1 .984.823l.12 1.203a3.5 3.5 0 0 0 6.752 0l.12-1.203a1 1 0 0 1 .984-.823h.518a3 3 0 0 1 3 3v2.688a2.5 2.5 0 0 1-2 2.312l-5.01-1.252a1 1 0 0 0-.98 0l-5.01 1.252a2.5 2.5 0 0 1-2-2.312V11.5a3 3 0 0 1 3-3Z" clip-rule="evenodd" /></svg>
                                </div>
                              }
                            }
                            <h4 class="text-xl font-bold capitalize transition-colors duration-500" [class]="theme() === 'dark' ? pathHeaderTextClasses().split(' ')[0].replace('from-', 'text-') : lightPathHeaderTextClasses().split(' ')[0].replace('from-', 'text-')">{{ category.key }}</h4>
                          </div>
                          <p class="text-slate-500 dark:text-slate-400 leading-relaxed whitespace-pre-wrap" [innerHTML]="highlightKeywords(category.value)"></p>
                        </div>
                        @if (result.sources && result.sources.length > 0) {
                          <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button (click)="toggleAnalysisSource(category.key)" class="flex justify-between items-center w-full text-sm font-semibold text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition">
                              <span>View Sources</span>
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 transition-transform duration-200" [class.rotate-180]="expandedAnalysisSource() === category.key">
                                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                              </svg>
                            </button>

                            @if (expandedAnalysisSource() === category.key) {
                              <div class="mt-3 text-left animate-fade-in-fast">
                                <ul class="list-disc list-inside space-y-2 text-xs text-slate-500 dark:text-slate-400">
                                  @for(source of result.sources; track source.web.uri) {
                                    <li>
                                      <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="text-indigo-500 dark:text-indigo-400 hover:underline break-words">{{ source.web.title || source.web.uri }}</a>
                                    </li>
                                  }
                                </ul>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
              @case ('sources') {
                <div class="animate-fade-in-up">
                  <div class="bg-white dark:bg-slate-800 rounded-xl p-6 mb-8 border border-slate-200 dark:border-slate-700">
                    <h3 class="text-2xl font-bold mb-3 transition-colors duration-500" [class]="theme() === 'dark' ? pathHeaderTextClasses().split(' ')[1].replace('to-', 'text-') : lightPathHeaderTextClasses().split(' ')[1].replace('to-', 'text-')">Sources</h3>
                    @if (result.sources && result.sources.length > 0) {
                      <ul class="list-disc list-inside space-y-2 text-slate-600 dark:text-slate-300">
                        @for(source of result.sources; track source.web.uri) {
                          <li>
                            <a [href]="source.web.uri" target="_blank" rel="noopener noreferrer" class="text-indigo-500 dark:text-indigo-400 hover:underline break-words">{{ source.web.title || source.web.uri }}</a>
                          </li>
                        }
                      </ul>
                    } @else {
                      <p class="text-slate-500 dark:text-slate-400">No external sources were cited for this analysis.</p>
                    }
                  </div>
                </div>
              }
            }
          </div>
        </section>
      }
    </div>
  </main>
}
